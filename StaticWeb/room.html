<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>SemOX.io</title>
      <link rel="icon" href="https://iconarchive.com/download/i103471/paomedia/small-n-flat/sign-check.ico" type="image/x-icon">
      <link rel="stylesheet" href="font.css">
      <script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script>
   </head>
   <body>

      <center>
         <div id = "icon">
            <a href="file:///C:/workspace/Sem_OX/StaticWeb/index.html">SemOX.io</a> 
         </div>
      </center>

      <br>
      
      <div id="hidden">
         
         <div id = "message"></div> <br>
         
         <div id = "chat">
            <input type="textarea" id="inputchat" onkeyup="onKeyUp()">
            <button onclick="send()">Send</button>
         </div> <br>
      
         
      </div>
      <div id = "userCount">

      </div>         
      <br>
      
      
      <div class="copylink">
         <center>
            <button class="copy">Copy and invite the link! </button></center>
      </div>   
      

   </body>
   <script>
    function getQueryStringObject() {
       // HTML 쿼리스트링 파싱하는 함수
      var a = window.location.search.substr(1).split('&');
      if (a == "") return {};
      var b = {};
      for (var i = 0; i < a.length; ++i) {
          var p = a[i].split('=', 2);
          if (p.length == 1)
              b[p[0]] = "";
          else
              b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
      }
      return b;
      }
   
      // 쿼리스트링 파싱
      var queryString = getQueryStringObject()
      
    function onKeyUp(){
      // Enter키 입력 시 전송하는 이벤트
       if(window.event.keyCode == 13){
          send()
       }
    }

    function send(){
      // 채팅 전송하는 이벤트
      let msg = document.getElementById('inputchat').value
      let chatBox = document.createElement('p')
      chatBox.setAttribute('class', 'mymessage')
      document.getElementById('message').appendChild(chatBox)
      chatBox.innerHTML = msg
      socket.emit('message', msg)
      document.getElementById('inputchat').value = '' 
       }


    
      if(queryString.name == undefined || queryString.name == null){
         // 닉네임 입력하는 이벤트
         let name = prompt('닉네임을 입력해주세요')
         location.href = "file:///C:/workspace/Sem_OX/StaticWeb/room.html?room=" + queryString.room + "&name=" + name
      }

      // Socket.io Connected
      var socketurl = "http://localhost:3000"
      var socket = io(socketurl,{transports: ['websocket', 'polling', 'flashsocket']});      

      // Socket의 이름, 방 연결
      socket.emit('room', queryString.room)
      socket.emit('name', queryString.name)
      
      socket.on('message',(msg)=>{
         // 채팅 도착 시 HTML에 로드해주는 이벤트
         let chatBox = document.createElement('p')
         chatBox.setAttribute('class', 'message')
         document.getElementById('message').appendChild(chatBox)
         chatBox.innerHTML = msg
      })

      socket.on('userCount', (data)=>{
         //유저 세기 
         document.getElementById('userCount').innerHTML = data
      })

      // 방 링크 복사하기
      document.querySelector(".copy").addEventListener("click", function(){
      var tempElem = document.createElement('textarea');
      tempElem.value = "file:///C:/workspace/Sem_OX/StaticWeb/room.html?room=" + queryString.room
      document.body.appendChild(tempElem);
      tempElem.select();
      document.execCommand("copy"); 
      document.body.removeChild(tempElem);
      });

      

       
      
 </script>   
</html>

